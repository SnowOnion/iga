<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>åšä¸½çµæ¢¦å¤§æˆ˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000;
            font-family: "ZCOOL XiaoWei", system-ui, -apple-system, sans-serif;
        }

        #gameContainer {
            position: relative;
            width: 100vmin;
            height: 100vmin;
            max-width: 100vw;
            max-height: 100vh;
        }

        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
        }

        #gameInfo {
            position: absolute;
            right: 10px;
            top: 10px;
            color: #fff;
            font-size: 18px;
            text-align: right;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #score, #powerLevel {
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            border-radius: 5px;
            white-space: nowrap;
        }

        #startMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        #difficulty {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            text-align: center;
            display: none;
            flex-direction: column;
            gap: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            text-align: center;
            display: none;
            flex-direction: column;
            gap: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .difficulty-btn, #restartBtn {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            font-family: inherit;
            transition: background 0.2s;
        }

        .difficulty-btn:hover, #restartBtn:hover {
            background: #666;
        }

        .dementor {
            position: absolute;
            pointer-events: none;
            z-index: 1;
            transform: translate(-50%, -50%);
        }

        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #666;
            font-size: 12px;
        }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 2;
        }

        .message button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .message button:hover {
            background: #45a049;
        }
    </style>
</head>

<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="gameInfo">
            <div id="score">åˆ†æ•°: 0</div>
            <div id="powerLevel">ç«åŠ›: 1</div>
        </div>
        <div id="startMessage" class="message">
            <h2>é€‰æ‹©éš¾åº¦</h2>
            <button id="easyBtn">ç®€å•</button>
            <button id="normalBtn">æ™®é€š</button>
            <button id="hardBtn">å›°éš¾</button>
        </div>
        <div id="gameOverMessage" class="message" style="display: none;">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>æœ€ç»ˆåˆ†æ•°: <span id="finalScore">0</span></p>
            <button id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    <div id="version">v0.1.14</div>

    <script>
        // æ¸¸æˆå°ºå¯¸
        const GAME_WIDTH = 400;
        const GAME_HEIGHT = Math.min(window.innerHeight, 800);

        // æ¸¸æˆçŠ¶æ€å˜é‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const maxPower = 10;
        const dementorElements = new Set();
        const spellCooldown = 200;  // å‘å°„é—´éš”ï¼ˆæ¯«ç§’ï¼‰

        let lastFrameTime = Date.now();
        let gameStarted = false;
        let isGameOver = false;
        let score = 0;
        let dementors = [];
        let spells = [];
        let powerUps = [];
        let lastSpawnTime = Date.now();
        let lastSpellTime = 0;
        let spellSpeed = 5;  // å­å¼¹é€Ÿåº¦
        let difficulty = 2;  // é»˜è®¤ä¸­ç­‰éš¾åº¦
        let deltaTime = 0;
        let animationFrameId;
        let player = {
            x: canvas.width / 2,
            y: canvas.height - 50,
            size: 30,
            power: 1,
            castingSpell: false
        };

        // è®¾ç½®ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            canvas.width = GAME_WIDTH;
            canvas.height = GAME_HEIGHT;
            
            // æ›´æ–°ç©å®¶ä½ç½®ï¼Œä½†ä¿æŒåœ¨æ°´å¹³æ–¹å‘çš„ç›¸å¯¹ä½ç½®
            const playerXRatio = player.x / GAME_WIDTH;
            player.x = GAME_WIDTH * playerXRatio;
            player.y = GAME_HEIGHT - 100;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function updatePlayer() {
            // è‡ªåŠ¨å‘å°„å­å¼¹
            const now = Date.now();
            if (now - lastSpellTime > spellCooldown) {
                for (let i = 0; i < player.power; i++) {
                    const offset = (i - (player.power - 1) / 2) * 20;  // å¤šä¸ªå­å¼¹ä¹‹é—´çš„é—´è·
                    spells.push({
                        x: player.x + offset,
                        y: player.y,
                        size: 10,
                        speed: spellSpeed
                    });
                }
                lastSpellTime = now;
                player.castingSpell = true;
                setTimeout(() => {
                    player.castingSpell = false;
                }, 100);
            }
        }

        function updateSpells() {
            for (let i = spells.length - 1; i >= 0; i--) {
                const spell = spells[i];
                spell.y -= spell.speed;

                // ç§»é™¤è¶…å‡ºå±å¹•çš„å­å¼¹
                if (spell.y < -spell.size) {
                    spells.splice(i, 1);
                    continue;
                }

                // ç»˜åˆ¶å­å¼¹
                const pos = getCanvasPosition(spell.x, spell.y);
                const scaledSize = spell.size * (canvas.getBoundingClientRect().width / canvas.width);
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, scaledSize / 2, 0, Math.PI * 2);
                ctx.fillStyle = player.castingSpell ? '#fff' : '#f00';
                ctx.fill();
            }
        }

        function updateDementors() {
            const now = Date.now();
            
            // æ ¹æ®éš¾åº¦è°ƒæ•´ç”Ÿæˆé—´éš”
            if (now - lastSpawnTime > 2000 / difficulty) {
                spawnDementor();
                lastSpawnTime = now;
            }

            for (let i = dementors.length - 1; i >= 0; i--) {
                const dementor = dementors[i];
                dementor.y += dementor.speed;

                // æ£€æŸ¥æ˜¯å¦è¢«å‡»ä¸­
                for (let j = spells.length - 1; j >= 0; j--) {
                    const spell = spells[j];
                    if (checkCollision(spell.x, spell.y, dementor.x, dementor.y, spell.size + dementor.size)) {
                        spells.splice(j, 1);
                        dementors.splice(i, 1);
                        score++;
                        document.getElementById('score').textContent = 'åˆ†æ•°: ' + score;
                        spawnPowerUp(dementor.x, dementor.y);
                        break;  // ä¸è¦ç›´æ¥ returnï¼Œç»§ç»­æ£€æŸ¥å…¶ä»–æ€ªç‰©
                    }
                }

                // æ£€æŸ¥æ˜¯å¦æ’åˆ°ç©å®¶
                if (checkCollision(player.x, player.y, dementor.x, dementor.y, player.size + dementor.size)) {
                    gameOver();
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•
                if (dementor.y > canvas.height + dementor.size) {
                    dementors.splice(i, 1);
                    continue;
                }

                // æ›´æ–°æ€ªç‰©ä½ç½®
                const pos = getCanvasPosition(dementor.x, dementor.y);
                const scaledSize = dementor.size * (canvas.getBoundingClientRect().width / canvas.width);
                const dementorEl = Array.from(dementorElements)[i];
                if (dementorEl) {
                    dementorEl.style.left = pos.x + 'px';
                    dementorEl.style.top = pos.y + 'px';
                    dementorEl.style.fontSize = scaledSize + 'px';
                }
            }
        }

        function updatePowerUps() {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                powerUp.y += powerUp.speed;

                // æ£€æŸ¥æ˜¯å¦è¢«æ”¶é›†
                if (checkCollision(player.x, player.y, powerUp.x, powerUp.y, player.size + powerUp.size)) {
                    if (powerUp.type === 'score') {
                        score += 3;
                        document.getElementById('score').textContent = 'åˆ†æ•°: ' + score;
                    } else if (powerUp.type === 'power') {
                        player.power = Math.min(player.power + 1, 10);
                        document.getElementById('powerLevel').textContent = 'ç«åŠ›: ' + player.power;
                    }
                    powerUps.splice(i, 1);
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•
                if (powerUp.y > canvas.height + powerUp.size) {
                    powerUps.splice(i, 1);
                    continue;
                }

                drawPowerUp(powerUp);
            }
        }

        function gameLoop() {
            const now = Date.now();
            deltaTime = now - lastFrameTime;
            lastFrameTime = now;

            clearCanvas();

            if (gameStarted && !isGameOver) {
                updatePlayer();
                updateSpells();
                updateDementors();
                updatePowerUps();
                drawWizard(player.x, player.y, player.size, player.castingSpell);
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function spawnDementor() {
            const speed = difficulty;  // æ ¹æ®éš¾åº¦è°ƒæ•´é€Ÿåº¦
            const size = Math.random() * 10 + 20;
            const x = Math.random() * (canvas.width - size);
            
            dementors.push({
                x: x,
                y: -size,
                size: size,
                speed: speed
            });

            const dementorEl = document.createElement('div');
            dementorEl.className = 'dementor';
            dementorEl.textContent = 'ğŸ‘»';
            document.body.appendChild(dementorEl);
            dementorElements.add(dementorEl);
        }

        function clearDementors() {
            // æ¸…é™¤æ‰€æœ‰ dementor å…ƒç´ 
            dementorElements.forEach(el => el.remove());
            dementorElements.clear();
        }

        function getCanvasPosition(x, y) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: rect.left + (x / scaleX),
                y: rect.top + (y / scaleY)
            };
        }

        function handleMove(screenX) {
            if (!isGameOver && gameStarted) {
                const canvasX = getCanvasX(screenX);
                player.x = Math.max(player.size / 2, Math.min(GAME_WIDTH - player.size / 2, canvasX));
            }
        }

        // è§¦æ‘¸äº‹ä»¶å¤„ç†
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!gameStarted) {
                document.getElementById('startMessage').style.display = 'flex';
            }
            const touch = e.touches[0];
            handleMove(touch.clientX);
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            handleMove(touch.clientX);
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
        }, { passive: false });

        // é¼ æ ‡äº‹ä»¶å¤„ç†
        canvas.addEventListener('mousemove', (e) => {
            if (!isGameOver && gameStarted) {
                handleMove(e.clientX);
            }
        });

        canvas.addEventListener('click', (e) => {
            if (!gameStarted) {
                document.getElementById('startMessage').style.display = 'flex';
            }
        });

        // æ¸¸æˆéš¾åº¦è®¾ç½®
        const easyBtn = document.getElementById('easyBtn');
        const normalBtn = document.getElementById('normalBtn');
        const hardBtn = document.getElementById('hardBtn');

        easyBtn.addEventListener('click', () => {
            difficulty = 1;
            startGame();
            gameStarted = true;
        });

        normalBtn.addEventListener('click', () => {
            difficulty = 2;
            startGame();
            gameStarted = true;
        });

        hardBtn.addEventListener('click', () => {
            difficulty = 3;
            startGame();
            gameStarted = true;
        });

        function drawWizard(x, y, size, castingSpell) {
            ctx.save();
            
            // ç»˜åˆ¶çº¢ç™½è´è¶ç»“ï¼ˆç§»åˆ°å¤´ä¸Šï¼‰
            const bowSize = size/4;
            // çº¢è‰²éƒ¨åˆ†
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.ellipse(x - bowSize/2, y - size*0.8, bowSize/2, bowSize/4, Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(x + bowSize/2, y - size*0.8, bowSize/2, bowSize/4, -Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
            // ç™½è‰²ä¸­å¿ƒ
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x, y - size*0.8, bowSize/4, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶è£™å­ï¼ˆçº¢è‰²ï¼‰
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.moveTo(x, y - size/2);
            ctx.lineTo(x - size/2, y + size/2);
            ctx.lineTo(x + size/2, y + size/2);
            ctx.closePath();
            ctx.fill();

            // ç»˜åˆ¶ç™½è‰²å›´è£™
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(x, y - size/3);
            ctx.lineTo(x - size/3, y + size/3);
            ctx.lineTo(x + size/3, y + size/3);
            ctx.closePath();
            ctx.fill();

            // ç»˜åˆ¶å¤´éƒ¨ï¼ˆç™½è‰²ï¼‰
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x, y - size/2, size/3, 0, Math.PI * 2);
            ctx.fill();

            // ç»˜åˆ¶é»‘è‰²é•¿å‘
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(x, y - size/2, size/3 + 2, Math.PI * 0.2, Math.PI * 0.8, true);
            ctx.fill();

            // ç»˜åˆ¶è¢–å­
            ctx.fillStyle = '#f00';
            // å·¦è¢–
            ctx.beginPath();
            ctx.ellipse(x - size/2, y, size/4, size/6, Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
            // å³è¢–
            ctx.beginPath();
            ctx.ellipse(x + size/2, y, size/4, size/6, -Math.PI/4, 0, Math.PI * 2);
            ctx.fill();

            // æ˜¾ç¤ºç¢°æ’åŒºåŸŸ
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.arc(x, y, size/6, 0, Math.PI * 2);
            ctx.stroke();

            ctx.restore();
        }

        function startGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameStarted = true;
            isGameOver = false;
            score = 0;
            lastSpawnTime = Date.now();
            lastSpellTime = 0;
            player.power = 1;
            player.castingSpell = false;
            dementors = [];
            spells = [];
            powerUps = [];

            // é‡ç½®åˆ†æ•°æ˜¾ç¤º
            document.getElementById('score').textContent = 'åˆ†æ•°: 0';

            // éšè—å¼€å§‹ç•Œé¢
            document.getElementById('startMessage').style.display = 'none';
            document.getElementById('gameOverMessage').style.display = 'none';

            // é‡ç½®ç©å®¶ä½ç½®
            player = {
                x: canvas.width / 2,
                y: canvas.height - 50,
                size: 30,
                power: 1,
                castingSpell: false
            };

            // æ¸…é™¤æ‰€æœ‰æ€ªç‰©å…ƒç´ 
            clearDementors();

            // é‡ç½®æ—¶é—´
            lastFrameTime = Date.now();

            // å¼€å§‹ç”Ÿæˆæ€ªç‰©
            startDementorSpawn();

            // å¼€å§‹æ¸¸æˆå¾ªç¯
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            gameLoop();
        }

        function gameOver() {
            isGameOver = true;
            gameStarted = false;
            finalScoreElement.textContent = score;
            document.getElementById('gameOverMessage').style.display = 'flex';
            document.getElementById('startMessage').style.display = 'none';
            // æ¸…é™¤æ€ªç‰©ç”Ÿæˆå®šæ—¶å™¨
            if (window.spawnInterval) {
                clearInterval(window.spawnInterval);
            }
            // æ¸…é™¤æ‰€æœ‰æ€ªç‰©å…ƒç´ 
            clearDementors();
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);  // å–æ¶ˆåŠ¨ç”»å¸§
            }
        }

        function restart() {
            document.getElementById('gameOverMessage').style.display = 'none';
            document.getElementById('startMessage').style.display = 'flex';
            // æ¸…é™¤æ‰€æœ‰æ€ªç‰©å…ƒç´ 
            clearDementors();
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);  // å–æ¶ˆåŠ¨ç”»å¸§
            }
            lastFrameTime = 0;  // é‡ç½®å¸§æ—¶é—´
        }

        function startDementorSpawn() {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
            if (window.spawnInterval) {
                clearInterval(window.spawnInterval);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            window.spawnInterval = setInterval(() => {
                if (!isGameOver && gameStarted) {
                    // æ ¹æ®éš¾åº¦ç”Ÿæˆæ€ªç‰©
                    for (let i = 0; i < 2; i++) {
                        spawnDementor();
                    }
                }
            }, 1000); // æ¯ç§’ç”Ÿæˆä¸€æ³¢
        }

        function getCanvasX(screenX) {
            const rect = canvas.getBoundingClientRect();
            const scale = GAME_WIDTH / rect.width;
            return (screenX - rect.left) * scale;
        }

        function drawPowerUp(powerUp) {
            const pos = getCanvasPosition(powerUp.x, powerUp.y);
            const scaledSize = powerUp.size * (canvas.getBoundingClientRect().width / canvas.width);
            
            const powerUpEl = document.createElement('div');
            powerUpEl.className = 'dementor';  // å¤ç”¨æ€ªç‰©çš„æ ·å¼
            powerUpEl.style.left = pos.x + 'px';
            powerUpEl.style.top = pos.y + 'px';
            powerUpEl.style.fontSize = scaledSize + 'px';
            powerUpEl.textContent = powerUp.emoji;
            document.body.appendChild(powerUpEl);
            dementorElements.add(powerUpEl);
        }

        function checkCollision(x1, y1, x2, y2, distance) {
            if (arguments.length === 5) {
                // ä¸»è§’çš„ç¢°æ’æ£€æµ‹ï¼ˆä¿æŒå°èŒƒå›´ï¼‰
                const actualDistance = distance / 3;
                return Math.hypot(x1 - x2, y1 - y2) < actualDistance;
            } else {
                // æ€ªç‰©çš„ç¢°æ’æ£€æµ‹ï¼ˆä¸æ˜¾ç¤ºå¤§å°æ¥è¿‘ï¼‰
                const obj1 = arguments[0];
                const obj2 = arguments[1];
                const dx = obj1.x - obj2.x;
                const dy = obj1.y - obj2.y;
                return Math.hypot(dx, dy) < obj1.size/2;
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function spawnPowerUp(x, y) {
            const type = Math.random() < 0.3 ? 'power' : 'score';  // 30% æ¦‚ç‡æ˜¯ç«åŠ›é“å…·
            powerUps.push({
                x: x,
                y: y,
                size: 15,
                speed: 2,
                type: type,
                emoji: type === 'power' ? 'âš¡ï¸' : 'ğŸ’'
            });
        }

        restartBtn.addEventListener('click', restart);

        gameLoop();
    </script>
</body>

</html>